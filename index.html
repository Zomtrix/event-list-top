<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReManga Valentine's Top</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; margin: 0; padding: 0; }
        
        /* Стилизация скроллбара */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Анимация загрузки */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: #ec4899;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Анимация появления */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Константы
        const BASE_IMG_URL = "https://remanga.org";
        const WAIFU_COUNT = 20;

        // Маппинг имен (ID -> Имя)
        const WAIFU_NAMES = {
            1: "Йор",
            2: "Аи",
            3: "Вайолет",
            4: "Асуна",
            5: "Zero 2",
            6: "Акаме",
            7: "Кейл Хенитус",
            8: "Ким Док Джа",
            9: "Ллойд Фронтера",
            10: "Маи",
            11: "Макима",
            12: "Марин",
            13: "Сейбер",
            14: "Рэм",
            15: "Момо",
            16: "Сон Джин Ву",
            17: "Фрирен",
            18: "Ча Хаэ Ин",
            19: "Эсдес",
            20: "Ю Джун Хёк"
        };

        // Список VIP пользователей с целевой Вайфу
        const VIP_LIST = [
            { id: 1585574, name: "Demoral", targetWaifuId: 10 }, // Маи
            { id: 1392119, name: "Bumaga", targetWaifuId: 15 }, // Момо
            { id: 3077407, name: "mix0222", targetWaifuId: 6 }, // Акаме
            { id: 3005627, name: "Cocaл", targetWaifuId: 1 }, // Йор
            { id: 3577437, name: "Кариэль", targetWaifuId: 2 }, // Аи
            { id: 3077491, name: "casas", targetWaifuId: 20 }, // Ю Джун Хёк
            { id: 3316052, name: "Пупупу_2", targetWaifuId: 11 }, // Макима
            { id: 3147529, name: "McDonaldsi", targetWaifuId: 14 }, // Рэм
            { id: 3077406, name: "Re_Caspaaaa", targetWaifuId: 13 }, // Сейбер
            { id: 40157, name: "Ell1e", targetWaifuId: 8 }, // Ким Док Джа
            { id: 3019924, name: "Mol-chun", targetWaifuId: 3 }, // Вайолет
            { id: 3482121, name: "crystal00008", targetWaifuId: 16 }, // Сон Джин Ву
            { id: 586648, name: "Caspaaaa", targetWaifuId: 4 }, // Асуна
            { id: 3549868, name: "Гпггпгпгпгпгпгпггп", targetWaifuId: 7 }, // Кейл Хенитус
            { id: 348423, name: "Demon_Emperor", targetWaifuId: 19 }, // Эсдес
            { id: 2005552, name: "Shiokаzе", targetWaifuId: 5 }, // Zero 2
            { id: 1857210, name: "Bouncer", targetWaifuId: 12 }, // Марин
            { id: 883604, name: "Usagichi", targetWaifuId: 17 }, // Фрирен
            { id: 3485309, name: "Spoong", targetWaifuId: 18 }, // Ча Хаэ Ин
            { id: 47916, name: "momonga", targetWaifuId: 9 } // Ллойд Фронтера
        ];

        // --- КОМПОНЕНТЫ ИКОНОК ---
        const RefreshIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
        );
        const ChevronDownIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        );
        const UserIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );
        const LogoutIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        );
        const StarIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
        );

        // --- ЭКРАН АВТОРИЗАЦИИ ---
        const LoginScreen = ({ onLogin }) => {
            const [inputToken, setInputToken] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (inputToken.trim()) {
                    onLogin(inputToken.trim());
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-800 via-gray-900 to-black p-4">
                    <div className="bg-gray-800/50 backdrop-blur-xl border border-gray-700 p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-500 mb-2">
                                ReManga Events
                            </h1>
                            <p className="text-gray-400 text-sm">Введите ваш токен для доступа к статистике</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">Bearer Token</label>
                                <input 
                                    type="text" 
                                    value={inputToken}
                                    onChange={(e) => setInputToken(e.target.value)}
                                    placeholder="ey..."
                                    className="w-full bg-gray-900/80 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500 transition-all placeholder-gray-600"
                                    required
                                />
                            </div>
                            <button 
                                type="submit" 
                                className="w-full bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white font-bold py-3 px-4 rounded-lg transition-all transform active:scale-95 shadow-lg shadow-pink-500/20"
                            >
                                Войти
                            </button>
                        </form>
                        <div className="mt-6 text-center text-xs text-gray-600">
                            Токен сохраняется локально в вашем браузере
                        </div>
                    </div>
                </div>
            );
        };

        // --- ОБЫЧНАЯ КАРТОЧКА ПОЛЬЗОВАТЕЛЯ ---
        const UserCard = ({ user, points, rank }) => {
            const avatarUrl = user.avatar?.mid 
                ? (user.avatar.mid.startsWith('http') ? user.avatar.mid : BASE_IMG_URL + user.avatar.mid)
                : "https://via.placeholder.com/100?text=?";
            
            const frameUrl = user.frame?.high 
                ? (user.frame.high.startsWith('http') ? user.frame.high : BASE_IMG_URL + user.frame.high)
                : null;

            // Стили рангов
            let rankStyle = "text-gray-400 font-bold text-lg";
            let cardStyle = "bg-gray-800 border-gray-700 hover:border-gray-600";
            let glow = "";
            
            if (rank === 1) {
                rankStyle = "text-yellow-400 font-black text-2xl";
                cardStyle = "bg-gradient-to-br from-gray-800 to-yellow-900/20 border-yellow-600/40";
                glow = "shadow-[0_0_15px_-3px_rgba(234,179,8,0.3)]";
            } else if (rank === 2) {
                rankStyle = "text-gray-300 font-black text-2xl";
                cardStyle = "bg-gradient-to-br from-gray-800 to-gray-700/50 border-gray-400/40";
            } else if (rank === 3) {
                rankStyle = "text-orange-400 font-black text-2xl";
                cardStyle = "bg-gradient-to-br from-gray-800 to-orange-900/20 border-orange-600/40";
            }

            return (
                <div className={`relative flex items-center p-4 rounded-xl border ${cardStyle} ${glow} shadow-md transition-all hover:-translate-y-1 duration-200 h-full`}>
                    <div className={`w-10 text-center flex-shrink-0 mr-3 ${rankStyle}`}>
                        #{rank}
                    </div>
                    <div className="relative w-16 h-16 mr-4 flex-shrink-0">
                        <div className="w-full h-full rounded-full overflow-hidden border-2 border-gray-700 bg-gray-900">
                            <img 
                                src={avatarUrl} 
                                alt={user.username} 
                                className="w-full h-full object-cover"
                                onError={(e) => {e.target.src = 'https://via.placeholder.com/100?text=User'}}
                            />
                        </div>
                        {frameUrl && (
                            <img src={frameUrl} className="absolute -top-[18%] -left-[18%] w-[136%] h-[136%] object-contain pointer-events-none z-10" alt="frame" />
                        )}
                    </div>
                    <div className="flex-grow min-w-0 pr-2">
                        <div className="font-bold text-white truncate text-base md:text-lg tracking-wide">
                            {user.username}
                        </div>
                        <div className="text-xs text-gray-500 font-mono">ID: {user.id}</div>
                    </div>
                    <div className="flex-shrink-0 text-right">
                        <div className="text-pink-400 font-bold text-lg md:text-xl tabular-nums tracking-tight">
                            {new Intl.NumberFormat('ru-RU').format(points)}
                        </div>
                        <div className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Points</div>
                    </div>
                </div>
            );
        };

        // --- VIP КАРТОЧКА ПОЛЬЗОВАТЕЛЯ ---
        const VipUserCard = ({ vipId, participations, userInfo, customName, targetWaifuId, targetThreshold }) => {
            // Ищем участие в ЦЕЛЕВОЙ вайфу
            const targetParticipation = participations.find(p => p.waifuId === targetWaifuId);
            
            // Проверяем, в Топ-30 ли он у ЦЕЛЕВОЙ вайфу
            const isTargetTop30 = targetParticipation && targetParticipation.rank <= 30;

            // Настройка стилей рамки
            let cardBorderClass = "border-red-600 bg-red-900/10 shadow-[0_0_10px_-3px_rgba(220,38,38,0.3)]";
            let statusText = "Не в топ-30";
            let statusColor = "text-red-400";

            if (isTargetTop30) {
                cardBorderClass = "border-green-600/50 bg-green-900/10 shadow-[0_0_15px_-5px_rgba(34,197,94,0.3)]";
                statusText = "В Топ-30!";
                statusColor = "text-green-400";
            }

            const username = customName || userInfo?.username || `ID: ${vipId}`;
            const avatarUrl = userInfo?.avatar?.mid 
                ? (userInfo.avatar.mid.startsWith('http') ? userInfo.avatar.mid : BASE_IMG_URL + userInfo.avatar.mid)
                : "https://via.placeholder.com/100?text=?";
            
            const targetWaifuName = WAIFU_NAMES[targetWaifuId];

            return (
                <div className={`relative flex flex-col p-5 rounded-xl border-2 ${cardBorderClass} transition-all h-full`}>
                    {/* Шапка карточки */}
                    <div className="flex items-center mb-4 border-b border-gray-700/50 pb-3">
                        <div className="relative w-12 h-12 mr-3 flex-shrink-0">
                            <img 
                                src={avatarUrl} 
                                className="w-full h-full rounded-full object-cover border border-gray-600"
                                onError={(e) => {e.target.src = 'https://via.placeholder.com/100?text=?'}}
                            />
                        </div>
                        <div className="flex-grow overflow-hidden">
                            <div className="font-bold text-white truncate text-lg leading-tight">
                                {username}
                            </div>
                            <div className={`text-xs font-bold uppercase ${statusColor} mt-1`}>
                                Цель: {targetWaifuName}
                            </div>
                        </div>
                    </div>

                    {/* Статус по Целевой Вайфу */}
                    <div className="bg-gray-800/80 rounded-lg p-3 mb-3 border border-gray-700">
                        <div className="flex justify-between items-center mb-1">
                            <span className="text-gray-400 text-xs uppercase font-bold tracking-wider">Статус цели</span>
                            {isTargetTop30 ? (
                                <span className="text-green-400 text-xs font-bold">#{targetParticipation.rank} Место</span>
                            ) : (
                                <span className="text-red-400 text-xs font-bold">Ниже 30</span>
                            )}
                        </div>
                        
                        {isTargetTop30 ? (
                            <div className="text-white font-mono text-lg font-bold">
                                {new Intl.NumberFormat('ru-RU').format(targetParticipation.points)} pts
                            </div>
                        ) : (
                            <div className="flex flex-col gap-1">
                                {targetParticipation ? (
                                    <div className="text-gray-400 text-sm">
                                        Сейчас: <span className="text-white">{new Intl.NumberFormat('ru-RU').format(targetParticipation.points)}</span> pts 
                                        <span className="text-xs text-gray-500"> (#{targetParticipation.rank})</span>
                                    </div>
                                ) : (
                                    <div className="text-gray-500 text-sm italic">Не найден в списке</div>
                                )}
                                
                                <div className="mt-1 pt-1 border-t border-gray-700">
                                    <div className="text-[10px] text-gray-500 uppercase">Порог 30 места</div>
                                    <div className="text-pink-400 font-mono font-bold">
                                        {new Intl.NumberFormat('ru-RU').format(targetThreshold)} pts
                                    </div>
                                    {targetParticipation && (
                                         <div className="text-[10px] text-red-400 mt-0.5">
                                            Нужно ещё: +{new Intl.NumberFormat('ru-RU').format(targetThreshold - targetParticipation.points)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Другие участия (свернуто/опционально или просто списком если есть) */}
                    {participations.length > 0 && (
                        <div className="mt-auto">
                            <div className="text-[10px] text-gray-500 uppercase font-bold mb-1">Активность ({participations.length})</div>
                            <div className="space-y-1 max-h-24 overflow-y-auto pr-1 scrollbar-thin">
                                {participations.map((p, idx) => {
                                    // Выделяем целевую вайфу жирным, остальные тусклее
                                    const isTarget = p.waifuId === targetWaifuId;
                                    return (
                                        <div key={idx} className={`flex justify-between text-xs ${isTarget ? 'text-white font-bold bg-white/10 p-1 rounded' : 'text-gray-400'}`}>
                                            <span>{WAIFU_NAMES[p.waifuId]}</span>
                                            <span>#{p.rank} ({new Intl.NumberFormat('ru-RU').format(p.points)})</span>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- ОСНОВНОЕ ПРИЛОЖЕНИЕ ---
        const Dashboard = ({ token, onLogout }) => {
            const [activeWaifu, setActiveWaifu] = useState(1); // 1...20 or 'vip'
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            
            // Данные для обычного режима
            const [data, setData] = useState([]);
            
            // Данные для VIP режима
            const [vipData, setVipData] = useState([]); 
            
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [useProxy, setUseProxy] = useState(true);

            // Закрытие меню
            const menuRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsMenuOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // Функция получения данных (обычная)
            const fetchStandardData = async (waifuId) => {
                const targetUrl = `https://api.remanga.org/api/v2/events/valentine_day/top-users/?waifu=waifu_${waifuId}`;
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                let jsonData;
                if (useProxy) {
                    try {
                        const proxyUrl1 = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
                        const response = await fetch(proxyUrl1, { headers });
                        if (!response.ok) throw new Error("Proxy 1 Error");
                        jsonData = await response.json();
                    } catch (err1) {
                        const proxyUrl2 = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
                        const response = await fetch(proxyUrl2);
                        if (!response.ok) throw new Error("All proxies failed");
                        jsonData = await response.json();
                    }
                } else {
                    const response = await fetch(targetUrl, { headers });
                    if (!response.ok) throw new Error("Network Error");
                    jsonData = await response.json();
                }
                return jsonData.sort((a, b) => b.total_points_spent - a.total_points_spent);
            };

            // Функция получения глобальных данных для VIP (все 20 запросов)
            const fetchGlobalVipData = async () => {
                setLoading(true);
                setError(null);
                
                try {
                    // Создаем массив промисов для всех 20 вайфу
                    const promises = Array.from({ length: WAIFU_COUNT }, (_, i) => fetchStandardData(i + 1).then(data => ({
                        waifuId: i + 1,
                        list: data
                    })).catch(err => ({ waifuId: i + 1, list: [], error: err })));

                    const results = await Promise.all(promises);

                    // Инициализируем карту VIP
                    const vipMap = {}; 
                    VIP_LIST.forEach(vip => {
                        vipMap[vip.id] = { userInfo: null, participations: [], customName: vip.name, targetWaifuId: vip.targetWaifuId };
                    });
                    
                    // Словарь порогов для всех вайфу { waifuId: thresholdPoints }
                    const thresholdsMap = {};

                    results.forEach(({ waifuId, list }) => {
                        if (!list || list.length === 0) {
                            thresholdsMap[waifuId] = 0;
                            return;
                        }

                        // Определяем порог 30-го места для этой вайфу
                        // Если людей меньше 30, то порог - это очки последнего, или 0. Но логичнее, если меньше 30, то попасть легко.
                        // Для строгости, если меньше 30, берем очки последнего.
                        const threshold30 = list.length >= 30 ? list[29].total_points_spent : (list.length > 0 ? list[list.length-1].total_points_spent : 0);
                        thresholdsMap[waifuId] = threshold30;

                        list.forEach((entry, index) => {
                            const userId = entry.user.id;
                            
                            // Если это один из наших VIP
                            if (vipMap[userId]) {
                                // Сохраняем инфо о юзере (если еще нет)
                                if (!vipMap[userId].userInfo) {
                                    vipMap[userId].userInfo = entry.user;
                                }

                                // Добавляем участие
                                vipMap[userId].participations.push({
                                    waifuId: waifuId,
                                    rank: index + 1,
                                    points: entry.total_points_spent,
                                    threshold30: threshold30
                                });
                            }
                        });
                    });

                    // Преобразуем в массив
                    const processedData = VIP_LIST.map(vip => ({
                        id: vip.id,
                        name: vip.name,
                        targetWaifuId: vip.targetWaifuId,
                        targetThreshold: thresholdsMap[vip.targetWaifuId] || 0,
                        userInfo: vipMap[vip.id].userInfo,
                        participations: vipMap[vip.id].participations.sort((a, b) => a.rank - b.rank) // Сортируем участия по лучшему месту
                    }));

                    setVipData(processedData);

                } catch (err) {
                    console.error(err);
                    setError("Ошибка при глобальном поиске. Попробуйте обновить.");
                } finally {
                    setLoading(false);
                }
            };

            // Эффект при смене вкладки
            useEffect(() => {
                const load = async () => {
                    if (activeWaifu === 'vip') {
                        await fetchGlobalVipData();
                    } else {
                        setLoading(true);
                        setError(null);
                        try {
                            const result = await fetchStandardData(activeWaifu);
                            setData(result);
                        } catch (err) {
                            console.error(err);
                            setError("Не удалось загрузить данные.");
                        } finally {
                            setLoading(false);
                        }
                    }
                };
                load();
            }, [activeWaifu]);

            // Расчет порога для обычного режима
            const thresholdPoints = activeWaifu !== 'vip' && data.length > 0 ? data[data.length - 1].total_points_spent : 0;
            const thresholdRank = activeWaifu !== 'vip' ? data.length : 0;

            return (
                <div className="min-h-screen bg-gray-900 flex flex-col fade-in">
                    
                    {/* ХЕДЕР */}
                    <header className="sticky top-0 z-40 bg-gray-900/95 backdrop-blur-md border-b border-gray-800 shadow-xl">
                        <div className="max-w-7xl mx-auto px-4 py-3">
                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                
                                <div className="flex items-center justify-between">
                                    <h1 className="text-2xl font-black italic bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500">
                                        Валентинов день
                                    </h1>
                                    <div className="md:hidden flex items-center gap-3">
                                         <button 
                                            onClick={() => activeWaifu === 'vip' ? fetchGlobalVipData() : fetchStandardData(activeWaifu).then(setData)} 
                                            disabled={loading}
                                            className={`p-2 text-gray-400 hover:text-white transition-colors ${loading ? 'animate-spin' : ''}`}
                                        >
                                            <RefreshIcon className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>

                                <div className="flex flex-1 items-center gap-4 md:justify-center">
                                    <div className="relative w-full md:w-72" ref={menuRef}>
                                        <button 
                                            onClick={() => setIsMenuOpen(!isMenuOpen)}
                                            className="w-full flex items-center justify-between bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-gray-500 text-white px-4 py-2.5 rounded-xl transition-all shadow-sm group"
                                        >
                                            <span className="font-semibold flex items-center gap-2 truncate">
                                                {activeWaifu === 'vip' ? (
                                                    <><StarIcon className="w-4 h-4 text-yellow-400" /> Текущие донатеры</>
                                                ) : (
                                                    <><span className="w-2 h-2 rounded-full bg-pink-500 animate-pulse"></span> {WAIFU_NAMES[activeWaifu] || `Waifu #${activeWaifu}`}</>
                                                )}
                                            </span>
                                            <ChevronDownIcon className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${isMenuOpen ? 'rotate-180' : ''}`} />
                                        </button>

                                        {isMenuOpen && (
                                            <div className="absolute top-full left-0 w-full mt-2 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl overflow-hidden z-50 max-h-[60vh] overflow-y-auto">
                                                <div className="p-2 grid grid-cols-1 gap-1">
                                                    {/* Вкладка VIP */}
                                                    <button
                                                        onClick={() => { setActiveWaifu('vip'); setIsMenuOpen(false); }}
                                                        className={`text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors ${
                                                            activeWaifu === 'vip' 
                                                            ? 'bg-yellow-600/20 text-yellow-400 border border-yellow-600/30' 
                                                            : 'text-yellow-200 hover:bg-gray-700 hover:text-white'
                                                        }`}
                                                    >
                                                        <StarIcon className="w-4 h-4" /> Текущие донатеры
                                                    </button>
                                                    <div className="h-px bg-gray-700 my-1 mx-2"></div>
                                                    
                                                    {/* Список Вайфу */}
                                                    {Array.from({ length: WAIFU_COUNT }, (_, i) => i + 1).map((num) => (
                                                        <button
                                                            key={num}
                                                            onClick={() => { setActiveWaifu(num); setIsMenuOpen(false); }}
                                                            className={`text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors ${
                                                                activeWaifu === num 
                                                                ? 'bg-pink-600/20 text-pink-400 border border-pink-600/30' 
                                                                : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                                            }`}
                                                        >
                                                            {WAIFU_NAMES[num] || `Waifu #${num}`}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <button 
                                        onClick={() => activeWaifu === 'vip' ? fetchGlobalVipData() : fetchStandardData(activeWaifu).then(setData)} 
                                        disabled={loading}
                                        className="hidden md:flex p-3 bg-gray-800 border border-gray-700 text-gray-300 hover:text-white hover:bg-gray-700 rounded-xl transition-all active:scale-95 shadow-sm"
                                        title="Обновить данные"
                                    >
                                        <RefreshIcon className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} />
                                    </button>
                                </div>

                                <div className="hidden md:flex items-center gap-4">
                                    <div className="flex items-center gap-2 text-xs font-medium text-gray-400 bg-gray-800/50 px-3 py-1.5 rounded-lg border border-gray-700/50">
                                        <label className="flex items-center cursor-pointer gap-2">
                                            <input type="checkbox" checked={useProxy} onChange={(e) => setUseProxy(e.target.checked)} className="rounded text-pink-500 focus:ring-0 bg-gray-700 border-gray-600" />
                                            <span>Proxy</span>
                                        </label>
                                    </div>
                                    <button onClick={onLogout} className="p-2 text-gray-500 hover:text-red-400 transition-colors" title="Выйти">
                                        <LogoutIcon className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* INFO BAR */}
                        <div className="bg-gray-900/90 border-b border-gray-800 py-2">
                            <div className="max-w-7xl mx-auto px-4 flex justify-between items-center text-xs md:text-sm">
                                {activeWaifu === 'vip' ? (
                                    <div className="flex items-center gap-2 text-gray-400 w-full justify-center">
                                        <span className="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span>
                                        <span>Глобальный поиск по {VIP_LIST.length} ID во всех категориях</span>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex items-center gap-4 text-gray-400">
                                            <div className="flex items-center gap-1.5">
                                                <span className="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                                <span>Live</span>
                                            </div>
                                            <div className="h-4 w-px bg-gray-700"></div>
                                            <div className="flex items-center gap-1.5">
                                                <UserIcon className="w-4 h-4" />
                                                <span>Участников: <span className="text-white font-mono">{data.length}</span></span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 bg-gray-800 px-3 py-1 rounded-full border border-gray-700 shadow-sm">
                                            <span className="text-gray-400">Порог (Топ-{thresholdRank}):</span>
                                            <span className="text-pink-400 font-bold font-mono">{loading ? '...' : new Intl.NumberFormat('ru-RU').format(thresholdPoints)}</span>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </header>

                    {/* КОНТЕНТ */}
                    <main className="flex-grow p-4 md:p-6 lg:p-8">
                        <div className="max-w-7xl mx-auto">
                            
                            {loading && (
                                <div className="flex flex-col items-center justify-center py-40">
                                    <div className="spinner mb-6"></div>
                                    <p className="text-gray-500 text-lg font-light animate-pulse">
                                        {activeWaifu === 'vip' ? 'Сканируем все 20 вайфу...' : 'Получаем данные...'}
                                    </p>
                                </div>
                            )}

                            {error && !loading && (
                                <div className="max-w-lg mx-auto bg-red-900/10 border border-red-500/20 text-red-400 p-6 rounded-2xl text-center my-10 backdrop-blur-sm">
                                    <p className="font-semibold mb-2 text-lg">Ошибка загрузки</p>
                                    <p className="text-sm opacity-80 mb-6">{error}</p>
                                    <button 
                                        onClick={() => activeWaifu === 'vip' ? fetchGlobalVipData() : fetchStandardData(activeWaifu).then(setData)} 
                                        className="px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition"
                                    >
                                        Повторить
                                    </button>
                                </div>
                            )}

                            {!loading && !error && (
                                <>
                                    {activeWaifu === 'vip' ? (
                                        // VIP GRID
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                            {vipData.map((item) => (
                                                <div key={item.id} className="fade-in">
                                                    <VipUserCard 
                                                        vipId={item.id} 
                                                        userInfo={item.userInfo} 
                                                        customName={item.name}
                                                        participations={item.participations}
                                                        targetWaifuId={item.targetWaifuId}
                                                        targetThreshold={item.targetThreshold}
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        // STANDARD GRID
                                        <>
                                            {data.length === 0 ? (
                                                <div className="text-center text-gray-600 py-40 text-xl font-light">
                                                    В этой категории пока пусто...
                                                </div>
                                            ) : (
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                                    {data.map((item, index) => (
                                                        <div key={`${item.user.id}-${index}`} className="fade-in" style={{animationDelay: `${index * 50}ms`}}>
                                                            <UserCard 
                                                                user={item.user} 
                                                                points={item.total_points_spent} 
                                                                rank={index + 1}
                                                            />
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </>
                                    )}
                                </>
                            )}
                        </div>
                    </main>

                    {/* Мобильный футер для выхода */}
                    <div className="md:hidden p-4 border-t border-gray-800 text-center">
                        <button onClick={onLogout} className="text-sm text-gray-500 hover:text-white underline decoration-gray-700">
                            Сменить токен
                        </button>
                    </div>
                </div>
            );
        };

        const RootApp = () => {
            const [token, setToken] = useState(localStorage.getItem('remanga_token') || '');
            const [isLoggedIn, setIsLoggedIn] = useState(false);

            useEffect(() => {
                if (token) {
                    setIsLoggedIn(true);
                }
            }, []);

            const handleLogin = (newToken) => {
                setToken(newToken);
                localStorage.setItem('remanga_token', newToken);
                setIsLoggedIn(true);
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
            };

            return (
                <>
                    {isLoggedIn ? (
                        <Dashboard token={token} onLogout={handleLogout} />
                    ) : (
                        <LoginScreen onLogin={handleLogin} />
                    )}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RootApp />);
    </script>
</body>
</html>