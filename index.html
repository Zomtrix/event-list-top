<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReManga Valentine's Top</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; margin: 0; padding: 0; }
        
        /* Стилизация скроллбара */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Анимация загрузки */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: #ec4899;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Анимация появления */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Константы
        const BASE_IMG_URL = "https://remanga.org";
        const WAIFU_COUNT = 20;

        // Маппинг имен (ID -> Имя)
        const WAIFU_NAMES = {
            1: "Йор",
            2: "Аи",
            3: "Вайолет",
            4: "Асуна",
            5: "Zero 2",
            6: "Акаме",
            7: "Кейл Хенитус",
            8: "Ким Док Джа",
            9: "Ллойд Фронтера",
            10: "Маи",
            11: "Макима",
            12: "Марин",
            13: "Сейбер",
            14: "Рэм",
            15: "Момо",
            16: "Сон Джин Ву",
            17: "Фрирен",
            18: "Ча Хаэ Ин",
            19: "Эсдес",
            20: "Ю Джун Хёк"
        };

        // --- КОМПОНЕНТЫ ИКОНОК ---
        const RefreshIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
        );
        const ChevronDownIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        );
        const UserIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );
        const LogoutIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        );

        // --- ЭКРАН АВТОРИЗАЦИИ ---
        const LoginScreen = ({ onLogin }) => {
            const [inputToken, setInputToken] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (inputToken.trim()) {
                    onLogin(inputToken.trim());
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-800 via-gray-900 to-black p-4">
                    <div className="bg-gray-800/50 backdrop-blur-xl border border-gray-700 p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-500 mb-2">
                                ReManga Events
                            </h1>
                            <p className="text-gray-400 text-sm">Введите ваш токен для доступа к статистике</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">Bearer Token</label>
                                <input 
                                    type="text" 
                                    value={inputToken}
                                    onChange={(e) => setInputToken(e.target.value)}
                                    placeholder="ey..."
                                    className="w-full bg-gray-900/80 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500 transition-all placeholder-gray-600"
                                    required
                                />
                            </div>
                            <button 
                                type="submit" 
                                className="w-full bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white font-bold py-3 px-4 rounded-lg transition-all transform active:scale-95 shadow-lg shadow-pink-500/20"
                            >
                                Войти
                            </button>
                        </form>
                        <div className="mt-6 text-center text-xs text-gray-600">
                            Токен сохраняется локально в вашем браузере
                        </div>
                    </div>
                </div>
            );
        };

        // --- КАРТОЧКА ПОЛЬЗОВАТЕЛЯ ---
        const UserCard = ({ user, points, rank }) => {
            const avatarUrl = user.avatar?.mid 
                ? (user.avatar.mid.startsWith('http') ? user.avatar.mid : BASE_IMG_URL + user.avatar.mid)
                : "https://via.placeholder.com/100?text=?";
            
            const frameUrl = user.frame?.high 
                ? (user.frame.high.startsWith('http') ? user.frame.high : BASE_IMG_URL + user.frame.high)
                : null;

            // Стили рангов
            let rankStyle = "text-gray-400 font-bold text-lg";
            let cardStyle = "bg-gray-800 border-gray-700 hover:border-gray-600";
            let glow = "";
            
            if (rank === 1) {
                rankStyle = "text-yellow-400 font-black text-2xl";
                cardStyle = "bg-gradient-to-br from-gray-800 to-yellow-900/20 border-yellow-600/40";
                glow = "shadow-[0_0_15px_-3px_rgba(234,179,8,0.3)]";
            } else if (rank === 2) {
                rankStyle = "text-gray-300 font-black text-2xl";
                cardStyle = "bg-gradient-to-br from-gray-800 to-gray-700/50 border-gray-400/40";
            } else if (rank === 3) {
                rankStyle = "text-orange-400 font-black text-2xl";
                cardStyle = "bg-gradient-to-br from-gray-800 to-orange-900/20 border-orange-600/40";
            }

            return (
                <div className={`relative flex items-center p-4 rounded-xl border ${cardStyle} ${glow} shadow-md transition-all hover:-translate-y-1 duration-200 h-full`}>
                    {/* Номер места */}
                    <div className={`w-10 text-center flex-shrink-0 mr-3 ${rankStyle}`}>
                        #{rank}
                    </div>

                    {/* Аватар */}
                    <div className="relative w-16 h-16 mr-4 flex-shrink-0">
                        <div className="w-full h-full rounded-full overflow-hidden border-2 border-gray-700 bg-gray-900">
                            <img 
                                src={avatarUrl} 
                                alt={user.username} 
                                className="w-full h-full object-cover"
                                onError={(e) => {e.target.src = 'https://via.placeholder.com/100?text=User'}}
                            />
                        </div>
                        {frameUrl && (
                            <img 
                                src={frameUrl} 
                                className="absolute -top-[18%] -left-[18%] w-[136%] h-[136%] object-contain pointer-events-none z-10"
                                alt="frame"
                            />
                        )}
                    </div>

                    {/* Инфо */}
                    <div className="flex-grow min-w-0 pr-2">
                        <div className="font-bold text-white truncate text-base md:text-lg tracking-wide">
                            {user.username}
                        </div>
                        <div className="text-xs text-gray-500 font-mono">ID: {user.id}</div>
                    </div>

                    {/* Очки */}
                    <div className="flex-shrink-0 text-right">
                        <div className="text-pink-400 font-bold text-lg md:text-xl tabular-nums tracking-tight">
                            {new Intl.NumberFormat('ru-RU').format(points)}
                        </div>
                        <div className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Points</div>
                    </div>
                </div>
            );
        };

        // --- ОСНОВНОЕ ПРИЛОЖЕНИЕ ---
        const Dashboard = ({ token, onLogout }) => {
            const [activeWaifu, setActiveWaifu] = useState(1);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [useProxy, setUseProxy] = useState(true);

            // Закрытие меню при клике вне
            const menuRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsMenuOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const fetchData = async () => {
                setLoading(true);
                setError(null);
                
                const targetUrl = `https://api.remanga.org/api/v2/events/valentine_day/top-users/?waifu=waifu_${activeWaifu}`;
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                try {
                    let jsonData;
                    if (useProxy) {
                        try {
                            const proxyUrl1 = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
                            const response = await fetch(proxyUrl1, { headers });
                            if (!response.ok) throw new Error("Proxy 1 Error");
                            jsonData = await response.json();
                        } catch (err1) {
                            console.warn("Switching to backup proxy...");
                            const proxyUrl2 = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
                            const response = await fetch(proxyUrl2); 
                            if (!response.ok) throw new Error("All proxies failed");
                            jsonData = await response.json();
                        }
                    } else {
                        const response = await fetch(targetUrl, { headers });
                        if (!response.ok) throw new Error("Network Error");
                        jsonData = await response.json();
                    }
                    
                    const sortedData = jsonData.sort((a, b) => b.total_points_spent - a.total_points_spent);
                    setData(sortedData);
                } catch (err) {
                    console.error(err);
                    setError("Не удалось загрузить данные. Проверьте токен или включите VPN/Прокси.");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
            }, [activeWaifu]);

            // Расчет порога вхождения (очки последнего человека в списке)
            const thresholdPoints = data.length > 0 ? data[data.length - 1].total_points_spent : 0;
            const thresholdRank = data.length;

            return (
                <div className="min-h-screen bg-gray-900 flex flex-col fade-in">
                    
                    {/* ХЕДЕР (Фиксированный) */}
                    <header className="sticky top-0 z-40 bg-gray-900/95 backdrop-blur-md border-b border-gray-800 shadow-xl">
                        <div className="max-w-7xl mx-auto px-4 py-3">
                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                
                                {/* Лого и Название */}
                                <div className="flex items-center justify-between">
                                    <h1 className="text-2xl font-black italic bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500">
                                        Валентинов День
                                    </h1>
                                    
                                    {/* Кнопка Меню (Мобильная) */}
                                    <div className="md:hidden flex items-center gap-3">
                                         <button 
                                            onClick={fetchData} 
                                            disabled={loading}
                                            className={`p-2 text-gray-400 hover:text-white transition-colors ${loading ? 'animate-spin' : ''}`}
                                        >
                                            <RefreshIcon className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>

                                {/* Центральная панель управления */}
                                <div className="flex flex-1 items-center gap-4 md:justify-center">
                                    
                                    {/* ВЫБОР ВАЙФУ (Dropdown) */}
                                    <div className="relative w-full md:w-64" ref={menuRef}>
                                        <button 
                                            onClick={() => setIsMenuOpen(!isMenuOpen)}
                                            className="w-full flex items-center justify-between bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-gray-500 text-white px-4 py-2.5 rounded-xl transition-all shadow-sm group"
                                        >
                                            <span className="font-semibold flex items-center gap-2">
                                                <span className="w-2 h-2 rounded-full bg-pink-500 animate-pulse"></span>
                                                {WAIFU_NAMES[activeWaifu] || `Waifu #${activeWaifu}`}
                                            </span>
                                            <ChevronDownIcon className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${isMenuOpen ? 'rotate-180' : ''}`} />
                                        </button>

                                        {/* Выпадающий список */}
                                        {isMenuOpen && (
                                            <div className="absolute top-full left-0 w-full mt-2 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl overflow-hidden z-50 max-h-[60vh] overflow-y-auto">
                                                <div className="p-2 grid grid-cols-1 gap-1">
                                                    {Array.from({ length: WAIFU_COUNT }, (_, i) => i + 1).map((num) => (
                                                        <button
                                                            key={num}
                                                            onClick={() => {
                                                                setActiveWaifu(num);
                                                                setIsMenuOpen(false);
                                                            }}
                                                            className={`text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors ${
                                                                activeWaifu === num 
                                                                ? 'bg-pink-600/20 text-pink-400 border border-pink-600/30' 
                                                                : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                                            }`}
                                                        >
                                                            {WAIFU_NAMES[num] || `Waifu #${num}`}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Desktop Refresh Button */}
                                    <button 
                                        onClick={fetchData} 
                                        disabled={loading}
                                        className="hidden md:flex p-3 bg-gray-800 border border-gray-700 text-gray-300 hover:text-white hover:bg-gray-700 rounded-xl transition-all active:scale-95 shadow-sm"
                                        title="Обновить данные"
                                    >
                                        <RefreshIcon className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} />
                                    </button>
                                </div>

                                {/* Правая панель (Настройки) */}
                                <div className="hidden md:flex items-center gap-4">
                                    <div className="flex items-center gap-2 text-xs font-medium text-gray-400 bg-gray-800/50 px-3 py-1.5 rounded-lg border border-gray-700/50">
                                        <label className="flex items-center cursor-pointer gap-2">
                                            <input type="checkbox" checked={useProxy} onChange={(e) => setUseProxy(e.target.checked)} className="rounded text-pink-500 focus:ring-0 bg-gray-700 border-gray-600" />
                                            <span>Proxy</span>
                                        </label>
                                    </div>
                                    <button 
                                        onClick={onLogout}
                                        className="p-2 text-gray-500 hover:text-red-400 transition-colors"
                                        title="Выйти"
                                    >
                                        <LogoutIcon className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* INFO BAR: Порог вхождения */}
                        <div className="bg-gray-900/90 border-b border-gray-800 py-2">
                            <div className="max-w-7xl mx-auto px-4 flex justify-between items-center text-xs md:text-sm">
                                <div className="flex items-center gap-4 text-gray-400">
                                    <div className="flex items-center gap-1.5">
                                        <span className="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                        <span>Live</span>
                                    </div>
                                    <div className="h-4 w-px bg-gray-700"></div>
                                    <div className="flex items-center gap-1.5">
                                        <UserIcon className="w-4 h-4" />
                                        <span>Участников: <span className="text-white font-mono">{data.length}</span></span>
                                    </div>
                                </div>

                                <div className="flex items-center gap-2 bg-gray-800 px-3 py-1 rounded-full border border-gray-700 shadow-sm">
                                    <span className="text-gray-400">Порог (Топ-{thresholdRank}):</span>
                                    <span className="text-pink-400 font-bold font-mono">{loading ? '...' : new Intl.NumberFormat('ru-RU').format(thresholdPoints)}</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* КОНТЕНТ */}
                    <main className="flex-grow p-4 md:p-6 lg:p-8">
                        <div className="max-w-7xl mx-auto">
                            
                            {loading && data.length === 0 && (
                                <div className="flex flex-col items-center justify-center py-40">
                                    <div className="spinner mb-6"></div>
                                    <p className="text-gray-500 text-lg font-light animate-pulse">Получаем данные...</p>
                                </div>
                            )}

                            {error && !loading && (
                                <div className="max-w-lg mx-auto bg-red-900/10 border border-red-500/20 text-red-400 p-6 rounded-2xl text-center my-10 backdrop-blur-sm">
                                    <div className="mb-4 text-4xl">⚠️</div>
                                    <p className="font-semibold mb-2 text-lg">Ошибка загрузки</p>
                                    <p className="text-sm opacity-80 mb-6">{error}</p>
                                    <button 
                                        onClick={fetchData} 
                                        className="px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition shadow-lg shadow-red-600/20 font-medium"
                                    >
                                        Повторить
                                    </button>
                                </div>
                            )}

                            {!loading && !error && data.length === 0 && (
                                <div className="text-center text-gray-600 py-40 text-xl font-light">
                                    В этой категории пока пусто...
                                </div>
                            )}

                            {/* Сетка карточек */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                {data.map((item, index) => (
                                    <div key={`${item.user.id}-${index}`} className="fade-in" style={{animationDelay: `${index * 50}ms`}}>
                                        <UserCard 
                                            user={item.user} 
                                            points={item.total_points_spent} 
                                            rank={index + 1}
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    {/* Мобильный футер для выхода */}
                    <div className="md:hidden p-4 border-t border-gray-800 text-center">
                        <button onClick={onLogout} className="text-sm text-gray-500 hover:text-white underline decoration-gray-700">
                            Сменить токен
                        </button>
                    </div>
                </div>
            );
        };

        const RootApp = () => {
            const [token, setToken] = useState(localStorage.getItem('remanga_token') || '');
            const [isLoggedIn, setIsLoggedIn] = useState(false);

            useEffect(() => {
                if (token) {
                    setIsLoggedIn(true);
                }
            }, []);

            const handleLogin = (newToken) => {
                setToken(newToken);
                localStorage.setItem('remanga_token', newToken);
                setIsLoggedIn(true);
            };

            const handleLogout = () => {
                // Опционально: можно стирать токен, но часто удобнее просто выйти на экран входа
                // setToken('');
                // localStorage.removeItem('remanga_token');
                setIsLoggedIn(false);
            };

            return (
                <>
                    {isLoggedIn ? (
                        <Dashboard token={token} onLogout={handleLogout} />
                    ) : (
                        <LoginScreen onLogin={handleLogin} />
                    )}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RootApp />);
    </script>
</body>
</html>